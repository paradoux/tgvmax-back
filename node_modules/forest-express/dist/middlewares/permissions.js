'use strict';

var PermissionsChecker = require('../services/permissions-checker');
var httpError = require('http-errors');
var logger = require('../services/logger');

var getRenderingFromUser = function getRenderingFromUser(user) {
  return user.relationships.renderings.data[0].id;
};

function createCheckPermission(environmentSecret, collectionName) {
  function checkPermission(permissionName) {
    return function (request, response, next) {
      var renderingId = getRenderingFromUser(request.user);

      return new PermissionsChecker(environmentSecret, renderingId, collectionName, permissionName).perform().then(next).catch(function (error) {
        logger.error(error.message);
        next(httpError(403));
      });
    };
  }

  function checkPermissionListAndSearch(request, response, next) {
    var searchToEdit = request.query.searchToEdit;

    var renderingId = getRenderingFromUser(request.user);
    var permissionName = searchToEdit ? 'searchToEdit' : 'list';

    return new PermissionsChecker(environmentSecret, renderingId, collectionName, permissionName).perform().then(next).catch(function (error) {
      logger.error(error.message);
      next(httpError(403));
    });
  }

  return {
    checkPermission: checkPermission,
    checkPermissionListAndSearch: checkPermissionListAndSearch
  };
}

module.exports = { createCheckPermission: createCheckPermission };