'use strict';

var P = require('bluebird');
var request = require('superagent');
var ServiceUrlGetter = require('./service-url-getter');
var ServerResponseHandler = require('./server-response-handler');

function AuthorizationFinder(renderingId, email, password, envSecret) {
  this.perform = function () {
    return new P(function (resolve, reject) {
      var forestUrl = new ServiceUrlGetter().perform();

      request.get(forestUrl + '/liana/v1/renderings/' + renderingId + '/authorization').set('forest-secret-key', envSecret).set('email', email).set('password', password).end(function (error, result) {
        new ServerResponseHandler(error, result).perform().then(function (data) {
          var user = data.attributes;

          user.id = data.id;
          resolve(user);
        }).catch(function () {
          return reject(new Error());
        });
      });
    });
  };
}

module.exports = AuthorizationFinder;